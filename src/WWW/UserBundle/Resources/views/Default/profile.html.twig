{% extends '::base.html.twig' %}
{% import 'macros/alert.html.twig' as alerts %}
{% block title %}
    Profile
{% endblock %}

{% block nav %}
    {{ parent() }}
    {{ include('nav/menu.html.twig') }}
{% endblock %}

{% block alert %}
    {% for flash_message in app.session.flashbag.get('mensaje') %}
       {{  alerts.alert('alert-warning', flash_message, null) }}
    {% endfor %}
    
    {% for flash_message in app.session.flashbag.get('mensaje2') %}
        {{  alerts.alert(null, flash_message, null) }}
     {% endfor %}
{% endblock %}
       
{% block body %}

    <ul class="nav nav-tabs" role="tablist">
        <li role="presentation" {{tabActive == 'personal' or tabActive is empty ? 'class="active"'}}>
            <a href="#personal" 
               name="personal" 
               id="sectionPersonal"
               aria-controls="personal" 
               role="tab" 
               data-toggle="tab">
               Personal
            </a>
        </li>

        <li role="presentation" {{tabActive == 'email' ? 'class="active"'}}>
            <a href="#email" 
               name="email" 
               id="sectionEmail"
               aria-controls="email" 
               role="tab" 
               data-toggle="tab">
               Email
            </a>
        </li>

        <li role="presentation" {{tabActive == 'password' ? 'class="active"'}}>
            <a href="#password" 
               name="password" 
               id="sectionPassword"
               aria-controls="password"
               role="tab" 
               data-toggle="tab">
                Contraseña
            </a>
        </li>

        <li role="presentation" {{tabActive == 'phone' ? 'class="active"'}}>
            <a href="#phone" 
               name="phone" 
               id="sectionTlfn"
               aria-controls="phone"
               role="tab" 
               data-toggle="tab">Teléfono</a>
        </li>

        <li role="presentation" {{tabActive == 'photo' ? 'class="active"'}}>
            <a href="#photo" 
               name="photo" 
               id="sectionPhoto"
               aria-controls="photo"
               role="tab" 
               data-toggle="tab">
                Foto
            </a>
        </li>

        <li role="presentation" {{tabActive == 'address' ? 'class="active"'}}>
            <a href="#address" 
               name="address" 
               id="sectionAddress"
               aria-controls="address"
               role="tab" 
               data-toggle="tab">
                Direcciones
            </a>
        </li>

        <li role="presentation" {{tabActive == 'bank' ? 'class="active"'}}>
            <a href="#bank" 
               name="bank" 
               id="sectionBank"
               aria-controls="bank"
               role="tab" 
               data-toggle="tab">
                Datos bancarios
            </a>
        </li>
        
        <li role="presentation" {{tabActive == 'myOffer' ? 'class= "active"' }}>
            <a href="#myOffer" 
               name="myOffer" 
               id="sectionMyOffer"
               aria-controls="myOffer"
               role="tab" 
               data-toggle="tab">
                Mis ofertas
            </a>
        </li>
        
        <li role="presentation" {{tabActive == 'myMessage' ? 'class= "active"' }}>
            <a href="#myMessage" 
               name="myMessage" 
               id="sectionMyMessage"
               aria-controls="myMessage"
               role="tab" 
               data-toggle="tab">
                Mis mensajes
            </a>
        </li>
        
    </ul>
          
    <div class="tab-content">
        {% block content3 %}
            {% for flash_message in app.session.flashbag.get('messageSuccess') %}
                {{ alerts.alert('alert-success', flash_message, null) }}
            {% endfor %}    
        {% endblock %}
        
        {% block content4 %}
            {% for flash_message in app.session.flashbag.get('messageFail') %}
                {{ alerts.alert('alert-warning', flash_message, null) }}
            {% endfor %}    
        {% endblock %}
        {{ form_errors(formPersonalData) }}
        {{ form_errors(formEmail) }}
        {{ form_errors(formPassword) }}
        {{ form_errors(formPhoto) }}
        {{ form_errors(formPhone) }}
        {{ form_errors(formAddresses) }}
        {{ form_errors(formBank) }}
        
        <div class="tab-pane {{tabActive == 'personal' or tabActive is empty ? 'active'}}" name="personal" id="personal">
            {{form_start(formPersonalData)}} 
                {{ form_row(formPersonalData.username) }}
                {{ form_row(formPersonalData.name) }}
                {{ form_row(formPersonalData.surname) }}
                {{ form_row(formPersonalData.sex) }}
                {{ form_row(formPersonalData.birthdate) }}
                {{ form_widget(formPersonalData.nif, { 'attr': {style:'display:none'} } )}}
                {{ form_row(formPersonalData.savePersonalData) }}
            {{form_end(formPersonalData)}}        
        </div>
        
        <div class="tab-pane {{tabActive == 'email' ? 'active'}}" name="email" id="email">
            {{form_start(formEmail)}} 
                Email actual: {{ email }} 
                {{ form_row(formEmail.email)}}
                {{ form_row(formEmail.passwordEnClaro) }}
                {{ form_row(formEmail.saveEmail) }}<br>
            {{form_end(formEmail)}}
        </div>
        
        <div class="tab-pane {{tabActive == 'password' ? 'active'}}" name="password" id="password">
         {{form_start(formPassword)}}    
            {{ form_row(formPassword.passwordEnClaro) }}
            {{ form_row(formPassword.password) }}
            {{ form_row(formPassword.savePassword) }}
        {{form_end(formPassword)}}    
        </div>
        
        <div class="tab-pane {{tabActive == 'phone' ? 'active'}}" name="phone" id="phone">
            {{form_start(formPhone)}} 
                <!-- Los dos próximos campos no se deberían de ver, deberían de 
                saltar después de darge a guardar que es cuando se envía el código -->
                {{ form_row(formPhone.confirmPhone) }}
                {{ form_row(formPhone.codConfirmation) }}
                <!-- Botón para que te envíe el código, el teléfono no se guarda 
                hasta que no se ha confirmado -->
                {{ form_row(formPhone.savePhone) }}
                {{ form_row(formPhone.prefix) }}
                {{ form_row(formPhone.phone) }}
            {{form_end(formPhone)}}    
                
        </div>
        
        <div class="tab-pane {{tabActive == 'photo' ? 'active'}}" name="photo" id="photo">
            {{form_start(formPhoto)}} 
                {{ form_row(formPhoto.photo.id) }}
                {{ form_row(formPhoto.photo.url, { 'attr': {style:'display:none'} }) }}
                {% if formPhoto.photo.url.vars.value is not empty %}
                    <img src="{{formPhoto.photo.url.vars.value}}" width="100" height="100" >
                {% endif %}    
                {{ form_row(formPhoto.photo.checkPhoto, { 'attr': {style:'display:none'} } ) }}

                <div id="profileImage">
                    <!-- contenedor donde se previsualizará la imagen a subir -->
                </div>  

                {{ form_row(formPhoto.fileImage) }}
                {{ form_row(formPhoto.savePhoto)}}
            {{form_end(formPhoto)}}
        </div>
            
        <div class="tab-pane {{tabActive == 'bank' ? 'active'}}" name="bank" id="bank">
            {{form_start(formBank)}} 
                {{ form_row(formBank.saveBank) }}
                {{ form_row(formBank.numAccount) }}
                {{ form_widget(formBank._token) }}
            {{form_end(formBank)}}
        </div>
        
        <div class="tab-pane {{tabActive == 'myOffer' ? 'active'}}" name="myOffer" id="myOffer">
            
            {% for offer in usuario.offers %}
                
                <div style="border:solid 1px orange; margin-top: 2em">
                    <h4>
                        <a href="{{path('user_profiler_offers' , {idOffer: offer.id})}}">
                            {{offer.title}}                  
                        </a> 
                    </h4>   
                    {{offer.description}}
                    <img src="{{offer.photos.0.url}}" />    

                </div>
                        
            {% endfor %}    
                
        </div>
        <div class="tab-pane {{tabActive == 'address' ? 'active'}}" name="address" id="address">
            {{form_start(formAddresses)}}
                {% for address in formAddresses.addresses %}
                    <div class="dataAddress" data-id="{{address.vars.value.id}}" style="border:solid 1px orange;">
                        {{form_widget(address.checkDeleteAddress, { 'attr': {'data-id' : address.vars.value.id } })}}
                        <h4>{{address.vars.value.name}}</h4><br>
                        {{address.vars.value.country}}<br>
                        {{address.vars.value.region}}<br>
                        {{address.vars.value.city}}<br>
                        {{address.vars.value.street}}<br>
                        {{address.vars.value.zipCode}}
                        {{form_row(address.id)}}

                        <button type="submit" name="profileUser[editAddress]" data-id: {{ address.vars.value.id }} 
                                class="btn-default btn editAddress">Editar </button>
                    </div>

                    <div style="border:solid 1px orange; display: none">
                        {{form_row(address.isDefault)}}
                        {{form_row(address.name)}}
                        {{form_row(address.country)}}
                        {{form_row(address.region)}}
                        {{form_row(address.city)}}
                        {{form_row(address.street)}}
                        {{form_row(address.zipCode)}}
                        {{form_row(address.editAddress)}}

                    </div>
                {% endfor %}
       

                <ul class="newAddress" data-prototype="{{ form_widget(formAddresses.addresses.vars.prototype)|e('html_attr') }}">

                </ul>
                {{ form_row(formAddresses.deleteAddresses) }}
                {{ form_row(formAddresses.addAddress, { 'attr': {style:'display:none'}})}}
            {{form_end(formAddresses)}}
        </div>
            
        <div class="tab-pane {{tabActive == 'myMessage' ? 'active'}}" name="myMessage" id="myMessage">
            {{ render(controller('UserBundle:Message:message',{request: app.request,'user': usuario})) }}
        </div>    
    </div>    


              
{% endblock %}

{% block javascriptsFooter %}
    {{ parent() }}
    <script>
        $('#myTabs a').click(function (e) {
            e.preventDefault();
            $(this).tab('show');
        });
    </script>
    
    <script type="text/javascript">
    $(document).scroll(function(e){
        var scrollTop = $(document).scrollTop();
        if(scrollTop > $('#menuAdministracion').height()){
            //console.log(scrollTop);
            $('#cbp-hrmenu').css("position","fixed");
            $('#cbp-hrmenu').css("top","0");
            $('#cbp-hrmenu').css("z-index","999");
        } else {
            $('#cbp-hrmenu').css("position","relative");
        }
    });
    
    </script>
    
    <script type="text/javascript">
        //Previsualización de las imágenes
        function archivo(evt) { 
                  var files = evt.target.files; // FileList object
             
                  // Obtenemos la imagen del campo "file".
                  for (var i = 0 ; i< files.length; i++) {
                        var f = files[i];
             
                    var reader = new FileReader();
             
                    reader.onload = (function(theFile) {
                        return function(e) {
                          // Insertamos la imagen
                         document.getElementById("profileImage").innerHTML = ['<img height="100" widht="100" src="', e.target.result,'" title="', escape(theFile.name), '"/>'].join('');
                        };
                    })(f);
             
                    reader.readAsDataURL(f);
                  }
              }
             
              document.getElementById('profilePhoto_fileImage').addEventListener('change', archivo, false);

    </script>
    
    <script type="text/javascript">


        $(document).ready(function() {
            
            var $collectionHolder;

            // setup an "add a tag" link
            var $addTagLink = $('<button class="add_tag_link">Nueva Dirección</button>');
            var $newLinkLi = $('<li></li>').append($addTagLink);

            jQuery(document).ready(function() {
                // Get the ul that holds the collection of tags
                $collectionHolder = $('ul.newAddress');

                // add the "add a tag" anchor and li to the tags ul
                $collectionHolder.append($newLinkLi);

                // count the current form inputs we have (e.g. 2), use that as the new
                // index when inserting a new item (e.g. 2)
                $collectionHolder.data('index', $collectionHolder.find(':input').length);

                $addTagLink.on('click', function(e) {
                    // prevent the link from creating a "#" on the URL
                    e.preventDefault();

                    // add a new tag form (see next code block)
                    addTagForm($collectionHolder, $newLinkLi);
                    
                    $('#profileAddress_deleteAddresses').css('display','none');
                    //Solo se permite añadir una dirección de una vez, 
                    //así que ocultamos el botón
                    $('.add_tag_link').css('display','none');
                    //Mostramos el botón de guardar una dirección nueva
                    $('#profileAddress_addAddress').css('display','block');
                });
            });
            
            function addTagForm($collectionHolder, $newLinkLi) {
                // Get the data-prototype explained earlier
                var prototype = $collectionHolder.data('prototype');

                // get the new index
                var index = $collectionHolder.data('index');

                // Replace '__name__' in the prototype's HTML to
                // instead be a number based on how many items we have
                var newForm = prototype.replace(/__name__/g, index);

                // increase the index with one for the next item
                $collectionHolder.data('index', index + 1);

                // Display the form in the page in an li, before the "Add a tag" link li
                var $newFormLi = $('<li></li>').append(newForm);
                $newLinkLi.before($newFormLi);
                
            }
           
            
            //$(document).on('click','.checkDeleteAddress', deleteAddresses);
            $(document).on('click','.add_tag_link',showHiddenButtonAdd);
            $(document).on('click','.newMessageButton', showFormNewMessage);
            $(document).on('click','.buttonDeleteMessage', deleteMessage);
            
            
            
            function deleteMessage(e){
                e.stopPropagation();
                //e.preventDefault();
                var arrayName = $(this).attr('id').split('_');
                var posArray = arrayName[2];
                var typeMessage = arrayName[1];
                
                $('#profileMessage_idRemove').val(posArray);
                $('#profileMessage_fromTo').val(typeMessage);
            }
            
            function showFormNewMessage(e){
                e.preventDefault();
                
                if($('.containeMessages').is(':visible')){
                    $('.containeMessages').hide();
                    $('#message_to, #message_message').attr('required',true);
                    $('.newMessage').show();
                    
                }else{
                    
                    $('.containeMessages').show();
                    $('#message_to, #message_message').attr('required',false);
                    $('.newMessage').hide();
                }
            }
            
            function editAddress(e){
                e.preventDefault();
                
                $('.dataAddress').css('display','none');
                $(this).parent().next().css('display','block');
                $('.add_tag_link').css('display','none');
                $('.editAddress').css('display','block');
                $('#profileUser_deleteAddresses').css('display','none');
            }
            
            function showHiddenButtonAdd(e){
                
            }
        });


    </script>
 
    <script type="text/javascript" src="{{ asset('js/profile.js') }}">  </script>
{% endblock %}

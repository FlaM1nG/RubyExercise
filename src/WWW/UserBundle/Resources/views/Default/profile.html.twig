{% extends '::base.html.twig' %}
{% import 'macros/alert.html.twig' as alerts %}


{% block title %}
    Profile
{% endblock %}

{% block nav %}
    {{ parent() }}
    {{ include('nav/menu.html.twig') }}
{% endblock %}

{% block alert %}
    
{% endblock %} 
      
{% block body %}
    <!-- TABULADOR DE PESTAÑAS -->
    <div class="container-fluid">
        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" {{tabActive == 'personal' or tabActive is empty ? 'class="active"'}}>
                <a href="#personal" 
                   name="personal" 
                   id="sectionPersonal"
                   aria-controls="personal" 
                   role="tab" 
                   data-toggle="tab">
                   Personal
                </a>
            </li>

            <li role="presentation" {{tabActive == 'email' ? 'class="active"'}}>
                <a href="#email" 
                   name="email" 
                   id="sectionEmail"
                   aria-controls="email" 
                   role="tab" 
                   data-toggle="tab">
                   Email
                </a>
            </li>

            <li role="presentation" {{tabActive == 'password' ? 'class="active"'}}>
                <a href="#password" 
                   name="password" 
                   id="sectionPassword"
                   aria-controls="password"
                   role="tab" 
                   data-toggle="tab">
                    Contraseña
                </a>
            </li>

            <li role="presentation" {{tabActive == 'phone' ? 'class="active"'}}>
                <a href="#phone" 
                   name="phone" 
                   id="sectionTlfn"
                   aria-controls="phone"
                   role="tab" 
                   data-toggle="tab">Teléfono</a>
            </li>

            <li role="presentation" {{tabActive == 'photo' ? 'class="active"'}}>
                <a href="#photo" 
                   name="photo" 
                   id="sectionPhoto"
                   aria-controls="photo"
                   role="tab" 
                   data-toggle="tab">
                    Foto
                </a>
            </li>

            <li role="presentation" {{tabActive == 'address' ? 'class="active"'}}>
                <a href="#address" 
                   name="address" 
                   id="sectionAddress"
                   aria-controls="address"
                   role="tab" 
                   data-toggle="tab">
                    Direcciones
                </a>
            </li>

            <li role="presentation" {{tabActive == 'bank' ? 'class="active"'}}>
                <a href="#bank" 
                   name="bank" 
                   id="sectionBank"
                   aria-controls="bank"
                   role="tab" 
                   data-toggle="tab">
                    Datos bancarios
                </a>
            </li>

            <li role="presentation" {{tabActive == 'myOffer' ? 'class= "active"' }}>
                <a href="#myOffer" 
                   name="myOffer" 
                   id="sectionMyOffer"
                   aria-controls="myOffer"
                   role="tab" 
                   data-toggle="tab">
                    Mis ofertas
                </a>
            </li>

            <li role="presentation" {{tabActive == 'myMessage' ? 'class= "active"' }}>
                <a href="#myMessage" 
                   name="myMessage" 
                   id="sectionMyMessage"
                   aria-controls="myMessage"
                   role="tab" 
                   data-toggle="tab">
                    Mis mensajes
                </a>
            </li>

        </ul>
    </div>
    <!-- FIN TABULADOR DE PESTAÑAS -->
    
                
    <!-- ERRORES EN EL FORMULARIO DE USUARIO -->            
    <div class="container">
        {% for flash_message in app.session.flashbag.get('messageSuccess') %}
            {{ alerts.alert('alert-success', flash_message, null) }}
        {% endfor %} 

        {% for flash_message in app.session.flashbag.get('messageFail') %}
            {{ alerts.alert('alert-warning', flash_message, null) }}
        {% endfor %}

        {{ form_errors(formulario) }}
    </div>
    <!-- FIN ERRORES EN EL FORMULARIO DE USUARIO -->  
    
    
    <div class="container">
        {{form_start(formulario)}}        
        <div class="tab-content">
            <!-- PERSONAL -->
            <div class="tab-pane 
                 {{tabActive == 'personal' or tabActive is empty ? 'active'}}" 
                 name="personal" id="personal">
                
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 us-col-pad">
                    {{ form_row(formulario.username) }}
                    </div>
                </div>
                    
                    
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 us-col-pad">
                        {{ form_row(formulario.name) }}
                    </div>
                    
                    
                    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 us-col-pad">
                        {{ form_row(formulario.surname) }}
                    </div>
                </div>
                    
                
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 us-col-pad">
                        {{ form_row(formulario.sex) }}
                    </div>
                    
                    
                    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 us-col-pad">
                        {{ form_row(formulario.birthdate) }}
                    </div>
                </div>
                    
                    
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 us-col-pad">
                    {{ form_widget(formulario.nif, { 'attr': {style:'display:none'} } )}}
                    </div>
                </div>
                    
                    
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 us-col-pad">
{#                    {{ form_row(formulario.linkInvitation) }}#}
                        <label class="control-label" 
                               for="profileUser_email_first">
                            Enlace de invitación
                        </label>
                        <p>{{ usuario.linkInvitation }}</p>
                    </div>
                </div>
                    
                
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 us-col-pad">
                    {{ form_row(formulario.savePersonalData) }}
                    </div>
                </div>
                    
                    
            </div>
            <!-- FIN PERSONAL -->
            
            
            <!-- EMAIL -->
            <div class="tab-pane {{tabActive == 'email' ? 'active'}}" name="email" id="email">
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 us-col-pad">
                        <label class="control-label" 
                               for="profileUser_email_first">
                            Email actual
                        </label>
                        <p>{{ email }}</p>
                    </div>
                </div>
                    
                    
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 us-col-pad">
                        {{ form_label(formulario.email.first) }}
                        {{ form_widget(formulario.email.first) }}
{#                {{ form_row(formulario.email)}}#}
                    </div>
                    
                    
                    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 us-col-pad">
                        {{ form_label(formulario.email.second) }}
                        {{ form_widget(formulario.email.second) }}
                    </div>
                </div>
                
                    
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 us-col-pad">
                        {{ form_row(formulario.passwordEnClaro) }}
                    </div>
                </div>
                    
                    
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 us-col-pad">
                        {{ form_row(formulario.saveEmail) }}
                    </div>
                </div>    
                
            </div>
            <!-- FIN EMAIL -->
            
            
            <!-- PASSWORD -->
            <div class="tab-pane {{tabActive == 'password' ? 'active'}}" name="password" id="password">
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 us-col-pad">
                        <label class="control-label" 
                            for="profileUser_passwordEnClaro">
                            Contraseña actual
                        </label>
                        <input type="password" id="profileUser_passwordEnClaro" 
                            name="profileUser[passwordEnClaro]" 
                            class="form-control">
                    </div>
                </div>
                    
                    
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 us-col-pad">
                        {{ form_label(formulario.password.first) }}
                        {{ form_widget(formulario.password.first) }}
                    </div>
                    
                    
                    <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 us-col-pad">
                        {{ form_label(formulario.password.second) }}
                        {{ form_widget(formulario.password.second) }}
                    </div>
                </div>
                
                
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 us-col-pad">
                        {{ form_row(formulario.savePassword) }}
                    </div>
                </div>
                
            </div>
            <!-- FIN PASSWORD -->
            
            
            <!-- PHONE -->
            <div class="tab-pane {{tabActive == 'phone' ? 'active'}}" name="phone" id="phone">
                <!-- Los dos próximos campos no se deberían de ver, deberían de 
                saltar después de darge a guardar que es cuando se envía el código -->
                {{ form_row(formulario.confirmPhone) }}
                {{ form_row(formulario.codConfirmation) }}
                <!-- Botón para que te envíe el código, el teléfono no se guarda 
                hasta que no se ha confirmado -->
                {{ form_row(formulario.savePhone) }}
                {{ form_row(formulario.prefix) }}
                {{ form_row(formulario.phone) }}
            </div>
            <!-- END -->
            
            
            <!-- PHOTO -->
            <div class="tab-pane {{tabActive == 'photo' ? 'active'}}" name="photo" id="photo">

                {{ form_row(formulario.photo.id) }}
                {{ form_row(formulario.photo.url, { 'attr': {style:'display:none'} }) }}
                {% if formulario.photo.url.vars.value is not empty %}
                    <img src="{{ formulario.photo.url.vars.value }}" width="100" height="100" >
                {% endif %}    
                {{ form_row(formulario.photo.checkPhoto, { 'attr': {style:'display:none'} } ) }}

                <div id="profileImage">
                    <!-- contenedor donde se previsualizará la imagen a subir -->
                </div>  

                {{ form_row(formulario.fileImage) }}
{#                <label class="control-label">Selecciona tu imagen de perfil</label>#}
{#                <input id="input-1" name="profileUser[fileImage]" type="file" class="file" accept="image/*">#}
                {{ form_row(formulario.savePhoto)}}
                <label class="control-label">Select File</label>
                <input id="input-1" type="file" class="file">

            </div>
            <!-- FIN PHOTO -->
            
            
            <!-- BANK -->
            <div class="tab-pane {{tabActive == 'bank' ? 'active'}}" name="bank" id="bank">

                    {{ form_row(formulario.saveBank) }}
                    {{ form_row(formulario.numAccount) }}

            </div>
            <!-- FIN BANK -->        
                    
            
            <!-- OFFER -->
            <div class="tab-pane {{tabActive == 'myOffer' ? 'active'}}" name="myOffer" id="myOffer">

                {% for offer in usuario.offers %}

                    <div style="border:solid 1px orange; margin-top: 2em">
                        <h4>
                            <a href="{{path('user_profiler_offers' , {offer: 'offer' ,idOffer: offer.id})}}">
                                {{offer.title}}                  
                            </a> 
                        </h4>   
                        {{offer.description}}
                        <img src="{{offer.photos.0.url}}" />    

                    </div>

                {% endfor %}    

            </div>
            <!-- FIN OFFER -->    
            
                
            <!-- ADDRESS -->    
            <div class="tab-pane {{tabActive == 'address' ? 'active'}}" name="address" id="address">

                {% for address in formulario.addresses %}
                    <div class="dataAddress" data-id="{{address.vars.value.id}}" style="border:solid 1px orange;">
                        {{form_widget(address.checkDeleteAddress, { 'attr': {'data-id' : address.vars.value.id } })}}
                        <h4>{{address.vars.value.name}}</h4><br>
                        {{address.vars.value.country}}<br>
                        {{address.vars.value.region}}<br>
                        {{address.vars.value.city}}<br>
                        {{address.vars.value.street}}<br>
                        {{address.vars.value.zipCode}}
                        {{form_row(address.id)}}

                        <button type="submit" name="profileUser[editAddress]" data-id: {{ address.vars.value.id }} 
                                class="btn-default btn editAddress">Editar </button>
                    </div>

                    <div style="border:solid 1px orange; display: none">
                        {{form_row(address.isDefault)}}
                        {{form_row(address.name)}}
                        {{form_row(address.country)}}
                        {{form_row(address.region)}}
                        {{form_row(address.city)}}
                        {{form_row(address.street)}}
                        {{form_row(address.zipCode)}}
                        {{form_row(address.editAddress)}}

                    </div>
                {% endfor %}
                {{ form_row(formulario.idDeletesAddresses) }}

                <ul class="newAddress" data-prototype="{{ form_widget(formulario.addresses.vars.prototype)|e('html_attr') }}">

                </ul>
                {{ form_row(formulario.deleteAddresses) }}
                {{ form_row(formulario.addAddress, { 'attr': {style:'display:none'}})}}

            </div>
            <!-- FIN ADDRESS -->    
            
            
            <!-- MESSAGE -->
            <div class="tab-pane {{tabActive == 'myMessage' ? 'active'}}" name="myMessage" id="myMessage">

            </div>
            <!-- MESSAGE -->
            
            
        </div>
            
            
    </div>
            

{{form_end(formulario)}}
{% endblock %}




{% block javascriptsFooter %}
    {{ parent() }}
    <script>
        $('#myTabs a').click(function (e) {
            e.preventDefault();
            $(this).tab('show');
        });
    </script>
    
    <script type="text/javascript">
    $(document).scroll(function(e){
        var scrollTop = $(document).scrollTop();
        if(scrollTop > $('#menuAdministracion').height()){
            //console.log(scrollTop);
            $('#cbp-hrmenu').css("position","fixed");
            $('#cbp-hrmenu').css("top","0");
            $('#cbp-hrmenu').css("z-index","999");
        } else {
            $('#cbp-hrmenu').css("position","relative");
        }
    });
    
    </script>
    
    <script type="text/javascript">
        //Previsualización de las imágenes
        function archivo(evt) { 
                  var files = evt.target.files; // FileList object
             
                  // Obtenemos la imagen del campo "file".
                  for (var i = 0 ; i< files.length; i++) {
                        var f = files[i];
             
                    var reader = new FileReader();
             
                    reader.onload = (function(theFile) {
                        return function(e) {
                          // Insertamos la imagen
                         document.getElementById("profileImage").innerHTML = ['<img height="100" widht="100" src="', e.target.result,'" title="', escape(theFile.name), '"/>'].join('');
                        };
                    })(f);
             
                    reader.readAsDataURL(f);
                  }
              }
             
              document.getElementById('profileUser_fileImage').addEventListener('change', archivo, false);

    </script>
    
    <script type="text/javascript">


        $(document).ready(function() {
            
            var $collectionHolder;

            // setup an "add a tag" link
            var $addTagLink = $('<button class="add_tag_link">Nueva Dirección</button>');
            var $newLinkLi = $('<li></li>').append($addTagLink);

            jQuery(document).ready(function() {
                // Get the ul that holds the collection of tags
                $collectionHolder = $('ul.newAddress');

                // add the "add a tag" anchor and li to the tags ul
                $collectionHolder.append($newLinkLi);

                // count the current form inputs we have (e.g. 2), use that as the new
                // index when inserting a new item (e.g. 2)
                $collectionHolder.data('index', $collectionHolder.find(':input').length);

                $addTagLink.on('click', function(e) {
                    // prevent the link from creating a "#" on the URL
                    e.preventDefault();

                    // add a new tag form (see next code block)
                    addTagForm($collectionHolder, $newLinkLi);
                    
                    $('#profileUser_deleteAddresses').css('display','none');
                    //Solo se permite añadir una dirección de una vez, 
                    //así que ocultamos el botón
                    $('.add_tag_link').css('display','none');
                    //Mostramos el botón de guardar una dirección nueva
                    $('#profileUser_addAddress').css('display','block');
                });
            });
            
            function addTagForm($collectionHolder, $newLinkLi) {
                // Get the data-prototype explained earlier
                var prototype = $collectionHolder.data('prototype');

                // get the new index
                var index = $collectionHolder.data('index');

                // Replace '__name__' in the prototype's HTML to
                // instead be a number based on how many items we have
                var newForm = prototype.replace(/__name__/g, index);

                // increase the index with one for the next item
                $collectionHolder.data('index', index + 1);

                // Display the form in the page in an li, before the "Add a tag" link li
                var $newFormLi = $('<li></li>').append(newForm);
                $newLinkLi.before($newFormLi);
                
            }
           
            
            $(document).on('click','.checkDeleteAddress', deleteAddresses);
            $(document).on('click','.editAddress', editAddress);
            $(document).on('click','.add_tag_link',showHiddenButtonAdd);
            
            function deleteAddresses(){
                
                var idsAddress =''; 
                
                $('.checkDeleteAddress:checked').each(function() {
                    
                    idsAddress = idsAddress + $(this).attr('data-id') + ',';  
                });
                
        
                //idsAddress = idsAddress.substr(-1);
                $('#profileUser_idDeletesAddresses').val(idsAddress);
                
            }
            
            function editAddress(e){
                e.preventDefault();
                
                $('.dataAddress').css('display','none');
                $(this).parent().next().css('display','block');
                $('.add_tag_link').css('display','none');
                $('.editAddress').css('display','block');
                $('#profileUser_deleteAddresses').css('display','none');
            }
            
            function showHiddenButtonAdd(e){
                
            }
        });


    </script>
    
    <script type="text/javascript" src="{{ asset('js/profile.js') }}">  </script>
    
    
    <script>
        $(document).ready(function(){
            $("#input-id").fileinput();
        });
    </script>
    
{% endblock %}

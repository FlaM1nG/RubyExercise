{#<script type="text/javascript">#}
    {#$(document).ready(function () {#}
{#{{ dump(arrayAddresses|json_encode) }}#}
        var regions = {{ arrayAddresses|json_encode|raw}};
        var a = [];

{#console.log(regions);#}

        {% if offer.region|lower != 'ceuta' and offer.region|lower != 'melilla' and offer.region|lower !='baleares' and
        offer.region|lower != 's.c.tenerife' and offer.region|lower != 'las palmas' %}

            showHiddenTesting();

        {% endif %}

        {% if offer.weight <= 30 %}
            $(document).on('click','input.check-send-method', actualizaGastosEnvio);
            $(document).on('change','#previoPago_addressPay', actualizaGastosEnvio);
            $(document).on('click','.checkPayMethod',actualizaGastosEnvio);
            $(document).on('click','#previoPago_sendOffice', actualizaGastosEnvio);

        {% else %}
            $(document).on('click','.checkPayMethod', function (){ actualizaGastosGestionPago(0)});
            $(document).on('click','#previoPago_sendOffice', function(){actualizaGastosGestionPago(0) });

        {% endif %}

        {#var arrayAddress = JSON.parse(addresses, function (key, value){#}
            {#var clave = parseInt(key);#}
            {#region[clave] = value;#}
            {#return region;#}
        {#});#}



        function actualizaGastosEnvio(){

            if($('.tra-testing')!= 'undefined' || $('.tra-noTesting') != undefined){
{#console.log('muestroOculto');#}
                showHiddenTesting();
            }

            var index = document.getElementById('previoPago_addressPay').value;
            var regionDestino = regions[index];
            var regionOrigen = '{{ offer.region|lower }}';

            var gastosEnvio = 0;
            var precioTotal = parseFloat({{ offer.price}});


            if(document.getElementById('sendMethod_correos').checked) {

                if(regionOrigen == 'las palmas' || regionOrigen == 's.c.tenerife' ||
                        regionDestino == 'las palmas' || regionDestino == 's.c.tenerife') {
                    gastosEnvio = parseFloat({{ arrayCourier.price_ca }});

                }else if(regionOrigen == 'baleares' || regionOrigen == 'melilla' || regionOrigen == 'ceuta' ||
                        regionDestino == 'baleares' || regionDestino == 'melilla' || regionDestino == 'ceuta') {

                    gastosEnvio = parseFloat({{ arrayCourier.price_ba }});
                }else {
                    gastosEnvio = parseFloat({{ arrayCourier.price_es }});
                }

            }else if(document.getElementById('sendMethod_others').checked){
                gastosEnvio = 0.00;
            }



            $('.gastosEnvio').html(parseFloat(gastosEnvio).toFixed(2)+' €');
            $('#previoPago_shippingCost').val(gastosEnvio);

            precioTotalAux = parseFloat(gastosEnvio + precioTotal).toFixed(2);

            var gastosGestion = calculaGastosGestion(precioTotalAux);

            precioTotalAux = parseFloat(precioTotalAux)+parseFloat(gastosGestion);

            actualizaGastosGestionPago(precioTotalAux);

        }

        function actualizaGastosGestionPago(precioTotal){
            var gastos = 0;
            var total = 0;
            var gastosTesteo = 0;

            if(document.getElementById('previoPago_sendOffice')!= null){
                gastosTesteo = calculaGastosComprobacion();
            }

            if(precioTotal == 0) {
                var precio = parseFloat({{ offer.price }});
                var gastosGestion = calculaGastosGestion(precio);

                total = parseFloat(precio + gastosGestion + gastosTesteo);

                if(!$('#previoPago_shippingCost').empty() ){
                    total = parseFloat(total+parseFloat(document.getElementById('previoPago_shippingCost').value));
                }

                if (document.getElementById('previoPago_payMethod_0').checked) {
                    gastos = total *{{ paypalFee }};
                }
                total = parseFloat(total+gastos);

            }else{
                precioTotal = parseFloat(precioTotal + gastosTesteo);

                if (document.getElementById('previoPago_payMethod_0').checked) {
                    gastos = parseFloat(precioTotal *{{ paypalFee }});

                    total = parseFloat(parseFloat(precioTotal) + parseFloat(gastos));
                }else{
                    total = precioTotal;
                }
            }


            $('.gestionPago').html(parseFloat(gastos).toFixed(2) + ' €');
            $('#previoPago_managementPayFee').val(parseFloat(gastos).toFixed(2));

            $('.precioTotal').html(parseFloat(total).toFixed(2)+' €');
            document.getElementById('previoPago_totalAmount').value = parseFloat(total).toFixed(2);

        }

        function calculaGastosComprobacion(){

            var price = {{ offer.price }}
            var percent = parseFloat({{ sendOfficePercent }});
            var gasto = 0.00

            if(document.getElementById('previoPago_sendOffice').checked) {

                gasto = price * percent;

                $('.gastosComprobacion').html(parseFloat(gasto).toFixed(2)+' €');
                document.getElementById('previoPago_testingCost').value = parseFloat(gasto).toFixed(2);

            }else{

                $('.gastosComprobacion').html(parseFloat(gasto).toFixed(2)+' €');
                document.getElementById('previoPago_testingCost').value = parseFloat(gasto).toFixed(2);
            }

            return gasto;
        }

        function showHiddenTesting(){

            var index = document.getElementById('previoPago_addressPay').value;
            var regionDestino = regions[index];
{#console.log('index '+index+' regionDestino '+regionDestino);#}
            if(regionDestino == 'ceuta' || regionDestino == 'melilla' || regionDestino == 'baleares'
            || regionDestino == 's.c.tenerife' || regionDestino == 'las palmas'){
{#console.log('debería de ocultar');#}
                $('.tra-testing').addClass('tra-noTesting');
                $('.tra-testing').removeClass('tra-testing');
                $('.tra-noTesting+tr').css('background','rgba(255,102,0,.5)')

            }else{
{#console.log('deberíai de mostrar');#}
                $('.tra-noTesting').addClass('tra-testing');
                $('.tra-noTesting').removeClass('tra-noTesting');
                $('.tra-testing+tr').css('background','rgba(0,0,0,0)')

            }
        }
    });
</script>
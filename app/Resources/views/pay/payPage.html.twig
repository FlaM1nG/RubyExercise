{% extends '::base.html.twig' %}
{% import 'macros/alert.html.twig' as alerts %}

{% block header %}
    {{ parent() }}
    {{ include('nav/menu.html.twig') }}
{% endblock %}

{% block alert %}

{% endblock %}

{% block body %}

  {{form_start(form)}}
    <div class="container cd-main-content">
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <h2>Confirmación datos de pago</h2>
                <hr/>
            </div>
        </div>

    {% if service == 1 or service == 2 %}

        <div class="cont-pago">
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 separacion-inferior">
                    <h4>Dirección</h4>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-12">
                    <div class="form-group">

                        {% if arrayAddresses is not empty %}
                            {{form_row(form.addressPay)}}
                        {% else %}
                            No tiene ninguna dirección creada, debe crear una para poder continuar con el proceso de compra <br>
                            Puede crear una nueva dirección pulsando <a href="{{ path('user_profiler_newAdress') }}">aquí</a>
                        {% endif %}
                    </div>
                </div>
            {% if arrayAddresses is not empty %}
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                    <div class="form-group">
                        <label class="form-cien">&nbsp;</label>
                        <a href="{{ path('user_profiler_newAdress') }}" class="btn btn-default btn-normal">Nueva dirección</a>
                        {#{{form_row(form.newAddress)}}#}
                    </div>
                </div>
            {% endif %}
            </div>

        {% if service == 1 and offer.category.id == 2 and offer.price >= 100 and
              (offer.region|lower != 'ceuta' and offer.region|lower != 'melilla' and offer.region|lower !='baleares' and
               offer.region|lower != 's.c.tenerife' and offer.region|lower != 'las palmas') %}
            <div class="row tra-testing">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 separacion-inferior">
                    <label class="checkbox-inline">
                    {{form_widget(form.sendOffice)}}

                    </label>
                </div>
            </div>
        {% endif %}

            {#<div class="row">#}
                {#<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 separacion-inferior">#}
                    {#<label class="checkbox-inline">#}
                        {#{{form_widget(form.facture)}}  #}
                      {##}
                    {#</label>#}
                {#</div>#}
            {#</div>#}

            {#<div class="row row-facturacion hidden">#}
                {#<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">#}
                    {#<div class="form-group">#}
                        {#{{form_row(form.dirFac)}}#}
                    {#</div>#}
                {#</div>#}

                {#<div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">#}
                    {#<div class="form-group">#}
                        {#<div class="form-group">#}
                            {#<label for="usr">DNI/NIF</label>#}
                            {#{{form_widget(form.dni)}}#}
                        {#</div>#}
                    {#</div>#}
                {#</div>#}
            {#</div>#}
        </div>
    {% endif %}

        <div class="cont-pago">
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 separacion-inferior">
                    <h4>Método de pago</h4>
                </div>
            </div>

            <div class="row row-payment-method">
                <div class="us-check-group-element col-lg-6 col-md-6 col-sm-6 col-xs-6">
                    <label class="check-payment-method center-block" title="Paypal">
                        <img class="img-responsive center-block img-metodo-pago" src="{{ asset('img/paypal.png') }}" />
                        {{ form_widget(form.payMethod.0, {'attr': {'class':'checkPayMethod center-block'}}) }}
                    </label>

                </div>

                <div class="us-check-group-element col-lg-6 col-md-6 col-sm-6 col-xs-6">
                    <label class="check-payment-method center-block" title="Tarjeta">
                        <img class="img-responsive center-block img-metodo-pago" src="{{ asset('img/tarjetas3.jpg') }}" />
                        {#{{form_widget(form.card)}}#}
                        {{ form_widget(form.payMethod.1, {'attr': {'class':'checkPayMethod center-block'}}) }}
                    </label>

                </div>
            </div>
        </div>

    <!-- Métodos de envío -->

    {% if service == 1 or service == 2 %}
        <div class="cont-pago">
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 separacion-inferior">
                    <h4>Método de envio</h4>
                </div>
            </div>

            <div class="row row-send-method">
        {# Si el trade viene con el array de precios vacío es por que el peso del paquete excede de 30kg #}
        {% if offer.weight <= 30 %}
                 <div class="us-check-group-element col-lg-6 col-md-6 col-sm-6 col-xs-6">
                    <label class="check-send-method center-block" title="Correos">
                        <img class="img-responsive center-block img-metodo-envio" src="{{ asset('img/correos.jpg') }}" />
                        {{ form_widget(form.sendMethod.0,{'id':'sendMethod_correos','attr': {'class':'check-send-method center-block'}}) }}
                    </label>

                </div>
        {% endif %}
                 <div class="us-check-group-element col-lg-6 col-md-6 col-sm-6 col-xs-6">
                    <label class="check-send-method center-block" title="Otros">
                        <img class="img-responsive center-block img-metodo-envio" src="{{ asset('img/otro.png') }}" />
                        {{ form_widget(form.sendMethod.1,{'id':'sendMethod_others','attr': {'class':'check-send-method center-block'}}) }}
                    </label>

                </div>
            </div>
        </div>

    {% endif %}
    <!-- Fin métodos de envío -->

        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 text-center">
                <h4>Total</h4>
                <h4 class="precioTotal">{{ form.totalAmount.vars.value|number_format(2, ',') }} €</h4>
                {{form_widget(form.totalAmount)}}
                {{form_row(form.submit, {'id': 'pagar_ofertas'})}}
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <table class="table table-striped table-pago">
                    <thead>
                        <tr>
                            <th>{{ offer.offer.title }}</th>
                            <th class="text-right">{{ offer.price|number_format(2, ',') }} €</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% if (service == 1 or service == 2) and offer.weight <= 30 %}
                        <tr>
                            <td>Gastos de envío</td>
                            <td class="text-right gastosEnvio">0.00 €</td>
                            {{ form_row(form.shippingCost) }}
                        </tr>
                    {% endif %}

                        <tr>
                            <td>Gastos de gestión</td>
                            <td class="text-right gastosGestion">0.00 €</td>
                            {{ form_row(form.managementFee) }}
                        </tr>

                    {% if service == 1 and offer.category.id == 2 and offer.price >= 100 and
                    (offer.region|lower != 'ceuta' and offer.region|lower != 'melilla' and offer.region|lower !='baleares' and
                    offer.region|lower != 's.c.tenerife' and offer.region|lower != 'las palmas')%}
                        <tr class="tra-testing">
                            <td>Gastos de comprobación</td>
                            <td class="text-right gastosComprobacion"> 0.00 €</td>
                            {{ form_row(form.testingCost) }}
                        </tr>
                    {% endif %}

                        <tr>
                            <td> Gastos de gestión de pago <span>+2% pago con paypal</span></td>
                            <td class="text-right gestionPago">0.00 €</td>
                            {{ form_row(form.managementPayFee) }}
                        </tr>
                        <tr class="table-pago-total">
                            <th></th>
                            <th>Precio Total</th>
                        </tr>
                        <tr class="table-pago-total">
                            <td></td>
                            <td class="precioTotal">{{ (offer.price)|number_format(2, ',') }} €</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

{% endblock %}

{% block javascriptsFooter %}
    {{ parent() }}

    {{ include('nav/menuScript.html.twig') }}

    <script type="text/javascript">
        $(document).ready(function () {

            function calculaGastosGestion(precioTotal){

                var gastos = precioTotal*{{ administrationFees }}

                $('.gastosGestion').html(parseFloat(gastos).toFixed(2)+' €');
                $('#previoPago_managementFee').val(gastos);

                return parseFloat(gastos).toFixed(2);

            }

            {# Funcionalidad para mostrar o no para realizar factura. #}
            $('.check-facturacion').on('click', function () {
                $('.row-facturacion').toggleClass('hidden');
            });

            {# Funcionalidad para elegir método de pago #}
            $('.check-payment-method').on('click', '.img-metodo-pago', function () {
                var elegido = $('.row-payment-method').find('.check-payment-method-checked');

                if($(elegido)){
                    $(elegido).toggleClass('check-payment-method-checked');
                }

                $(this).parent().toggleClass('check-payment-method-checked');
            });


            {# Funcionalidad para elegir método de envio #}
            $('.check-send-method').on('click', '.img-metodo-envio', function () {
                var elegido = $('.row-send-method').find('.check-send-method-checked');

                if($(elegido)){
                    $(elegido).toggleClass('check-send-method-checked');
                }

                $(this).parent().toggleClass('check-send-method-checked');
            });

            {% if (service == 1 or service == 2) and arrayAddresses is not empty %}
                    {{ include('pay/payGastosEnvio.html.twig') }}

            {% else %}

                $(document).on('click','.checkPayMethod', function (){ actualizaGastosGestionPago();});

                function actualizaGastosGestionPago(){
                    var gastos = 0;
                    var total = 0;
                    var administrationFees = calculaGastosGestion({{ offer.price }});
                    var precio = parseFloat({{ offer.price }})

                    total = parseFloat(precio) + parseFloat(administrationFees);

                    if (document.getElementById('previoPago_payMethod_0').checked) {
                        gastos = total *{{ paypalFee }};
                    }

                    total = parseFloat(total+gastos);


                    $('.gestionPago').html(parseFloat(gastos).toFixed(2) + ' €');
                    $('#previoPago_managementPayFee').val(parseFloat(gastos).toFixed(2));

                    $('.precioTotal').html(parseFloat(total).toFixed(2)+' €');
                    document.getElementById('previoPago_totalAmount').value = parseFloat(total).toFixed(2);

                }

            {% endif %}


            {# Validación de datos para pago #}
            {#$('#pagar_ofertas').on('click', function () {#}
                {#var alerta;#}
                {#var mensaje = "- Vacio";#}

                {# Comprueba de la dirección de envio no sea nula #}
                {#if($('#dir_envio').val() == null | $('#dir_envio').val() == 'null'){#}

                {#}#}

                {#mensaje = mensaje.concat("\n- LLENO");#}

                {#if($('.alert-zone').length != 0){#}

                    {#$('.alert-zone').text(mensaje);#}
                    {#$('.alert-zone').text().replace(/\n/g,'<br/>');#}
                {#}else{#}
                    {#alerta = `{% spaceless %}{{ alerts.alert('alert-danger alert-zone', 'Vacio') }}{% endspaceless %}`;#}
                    {#$('#blockAlert').html(alerta);#}
                {#}#}


            {#});#}

        });
    </script>
{% endblock %}

{% block footer %}
    {{ include('footer/sponsorFooter.html.twig') }}
    {{ parent() }}
{% endblock %}
